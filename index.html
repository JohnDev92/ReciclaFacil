<!DOCTYPE html>
<html>

<head>
    <title>ReciclaF√°cil - Santa Cruz da Serra</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        #container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        #map {
            flex: 1;
            padding-bottom: 100px;
        }

        #form-container {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        #form-container input[type="text"] {
            width: 60%;
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        #form-container button {
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }

        #sidebar {
            position: absolute;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background: #f0f0f0;
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 900;
            padding: 10px;
            box-shadow: -2px 0 6px rgba(0, 0, 0, 0.2);
        }

        #sidebar.active {
            right: 0;
        }

        #sidebar h3 {
            margin-top: 0;
        }

        #sidebar ul {
            list-style: none;
            padding-left: 0;
        }

        #sidebar li {
            padding: 5px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #sidebar li span {
            cursor: pointer;
            margin-left: 10px;
        }

        #sidebar li span.excluir {
            color: red;
        }

        #control-bar {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        #contact-buttons,
        #map-controls {
            display: flex;
            gap: 8px;
        }

        .btn-contact,
        .btn-control {
            padding: 10px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .btn-whatsapp:hover {
            background: #20BA5A;
        }

        .btn-phone {
            background: #2196F3;
            color: white;
        }

        .btn-phone:hover {
            background: #1976D2;
        }

        .btn-control {
            background: #4CAF50;
            color: white;
        }

        .btn-control:hover {
            background: #45a049;
        }

        @media(max-width:768px) {
            #control-bar {
                flex-direction: column;
                align-items: stretch;
            }

            #contact-buttons,
            #map-controls {
                flex-direction: column;
                width: 100%;
            }

            .btn-contact,
            .btn-control {
                width: 100%;
                text-align: center;
            }
        }

        @media(max-width:600px) {
            #sidebar {
                width: 200px;
            }

            #form-container input[type="text"] {
                width: 55%;
            }
        }

        .btn-education {
            background: #FF9800;
            color: white;
        }

        .btn-education:hover {
            background: #F57C00;
        }

        .btn-stats {
            background: #9C27B0;
            color: white;
        }

        .btn-stats:hover {
            background: #7B1FA2;
        }

        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow-y: auto;
        }

        #modal-content {
            position: relative;
            max-width: 900px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        #modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            background: none;
            border: none;
        }

        #modal-close:hover {
            color: #000;
        }

        .education-image {
            width: 100%;
            max-width: 100%;
            height: auto;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #stats-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 2001;
            min-width: 400px;
        }

        #stats-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }

        .stat-item {
            padding: 15px;
            margin: 10px 0;
            background: #f5f5f5;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }

        .stat-item h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .stat-item p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }

        @media(max-width:768px) {
            #modal-content {
                margin: 20px;
                padding: 20px;
            }

            #stats-panel {
                min-width: 300px;
                max-width: 90%;
            }
        }
    </style>
</head>

<body>

    <div id="container">
        <div id="map"></div>

        <div id="form-container">
            <label>Nome do Ponto:</label>
            <input type="text" id="nome" placeholder="Ex: Ponto D">
            <button onclick="adicionarMarcador()">Adicionar</button>
            <button onclick="fecharFormulario()">Cancelar</button>
        </div>

        <div id="sidebar">
            <h3>ReciclaF√°cil - Pontos de Coleta</h3>
            <ul id="ul-pontos"></ul>
        </div>

        <div id="control-bar">
            <div id="contact-buttons">
                <a href="https://wa.me/5521990191331" target="_blank" class="btn-contact btn-whatsapp"
                    aria-label="WhatsApp Jogue Limpo/Disk Entulho">
                    <img src="imagens/whatsapp_icon.png" alt="WhatsApp" style="width:20px; height:20px; vertical-align:middle; margin-right:6px;"> WhatsApp - Jogue Limpo/Disk Entulho
                </a>
                <a href="tel:+552139001651" class="btn-contact btn-phone" aria-label="Ligue para Prefeitura">
                    üìû Ligue para Prefeitura (seg-sex 8h-17h)
                </a>
            </div>
            <div id="map-controls">
                <button id="btnEducation" class="btn-control btn-education">üìö Conte√∫do Educativo</button>
                <button id="toggleLayer" class="btn-control">üó∫Ô∏è Alternar Camada</button>
                <button id="toggleSidebar" class="btn-control">üìç Pontos</button>
                <button id="btnStats" class="btn-control btn-stats" style="display:none;">üìä Estat√≠sticas</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div id="modal-content">
            <button id="modal-close">&times;</button>
            <h2 style="margin-top:0; color:#333;">üìö Conte√∫do Educativo sobre Reciclagem</h2>
            <p style="color:#666; margin-bottom:20px;">Aprenda mais sobre como separar e reciclar corretamente seus res√≠duos.</p>
            <div id="education-images">
                <img src="imagens/educativo1.jpg" alt="Conte√∫do Educativo 1" class="education-image" onerror="this.style.display='none'">
                <img src="imagens/educativo2.jpg" alt="Conte√∫do Educativo 2" class="education-image" onerror="this.style.display='none'">
                <img src="imagens/educativo3.jpg" alt="Conte√∫do Educativo 3" class="education-image" onerror="this.style.display='none'">
            </div>
            <p style="color:#999; font-size:12px; margin-top:30px;">
                <strong>Nota:</strong> Para adicionar suas pr√≥prias imagens educativas, coloque os arquivos na pasta <code>imagens/</code> 
                com os nomes educativo1.jpg, educativo2.jpg, educativo3.jpg, etc.
            </p>
        </div>
    </div>

    <div id="stats-overlay"></div>
    <div id="stats-panel">
        <h2 style="margin-top:0; color:#333;">üìä Estat√≠sticas do ReciclaF√°cil</h2>
        <div class="stat-item">
            <h4>üë• Total de Acessos</h4>
            <p id="stat-visits">0</p>
        </div>
        <div class="stat-item" style="border-left-color:#25D366;">
            <h4>üí¨ Cliques no WhatsApp</h4>
            <p id="stat-whatsapp" style="color:#25D366;">0</p>
        </div>
        <div class="stat-item" style="border-left-color:#2196F3;">
            <h4>üìû Cliques no Telefone</h4>
            <p id="stat-phone" style="color:#2196F3;">0</p>
        </div>
        <button onclick="closeStats()" style="margin-top:20px; padding:10px 20px; background:#4CAF50; color:white; border:none; border-radius:5px; cursor:pointer; width:100%;">Fechar</button>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        var map = L.map('map').setView([-22.641560, -43.278042], 17);

        // Camadas
        var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors, Humanitarian OSM'
        });
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics, USDA, USGS, AEX, GeoEye',
            maxZoom: 19
        });
        streetLayer.addTo(map);
        var camadaAtual = 'street';

        document.getElementById('toggleLayer').onclick = function () {
            if (camadaAtual === 'street') {map.removeLayer(streetLayer); satelliteLayer.addTo(map); camadaAtual = 'satellite';}
            else {map.removeLayer(satelliteLayer); streetLayer.addTo(map); camadaAtual = 'street';}
        }

        var marcadorAtual = null;
        var markersCluster = L.markerClusterGroup();

        // PONTOS PR√â-CARREGADOS DE SANTA CRUZ DA SERRA
        var pontosColeta = [
            {"nome": "Ponto A", "lat": -22.641560, "lon": -43.278042},
            {"nome": "Ponto B", "lat": -22.640240, "lon": -43.275354},
            {"nome": "Ponto C", "lat": -22.638923, "lon": -43.272392},
            {"nome": "Ponto D", "lat": -22.646208, "lon": -43.272710}
        ];

        const BIN_ID = "689f65d4ae596e708fcad177";
        const MASTER_KEY = "689f673443b1c97be91f1e5c";
        const JSON_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        function atualizarMapa() {
            markersCluster.clearLayers();

            var recycleIcon = L.icon({
                iconUrl: 'imagens/recycle_icon_28px.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });


            pontosColeta.forEach(function (ponto, index) {
                var marker = L.marker([ponto.lat, ponto.lon], {icon: recycleIcon})
                    .bindPopup("<b>ReciclaF√°cil: " + ponto.nome + "</b>");
                markersCluster.addLayer(marker);
            });

            map.addLayer(markersCluster);
            atualizarLista();
        }

        function atualizarLista() {
            var ul = document.getElementById('ul-pontos'); ul.innerHTML = '';
            pontosColeta.forEach(function (ponto, index) {
                var li = document.createElement('li');
                li.innerHTML = `<span onclick="zoomParaPonto(${index})">${ponto.nome}</span>
                          <span class="excluir" onclick="excluirPonto(${index})">‚úñ</span>`;
                ul.appendChild(li);
            });
        }

        function zoomParaPonto(index) {
            map.setView([pontosColeta[index].lat, pontosColeta[index].lon], 18);
            markersCluster.eachLayer(function (marker) {
                if (marker.getLatLng().lat === pontosColeta[index].lat && marker.getLatLng().lng === pontosColeta[index].lon)
                    marker.openPopup();
            });
        }

        async function excluirPonto(index) {
            if (confirm(`Deseja realmente excluir o ponto "${pontosColeta[index].nome}"?`)) {
                pontosColeta.splice(index, 1);
                atualizarMapa();
                // Tenta atualizar no JSONBin, mas ignora erro
                try {await fetch(JSON_URL, {method: "PUT", headers: {"Content-Type": "application/json", "X-Master-Key": MASTER_KEY}, body: JSON.stringify(pontosColeta)});} catch (e) {console.warn("Erro ao salvar no JSONBin:", e);}
            }
        }

        map.on('click', function (e) {
            document.getElementById('form-container').style.display = 'block';
            marcadorAtual = e.latlng;
        });

        async function adicionarMarcador() {
            var nome = document.getElementById('nome').value;
            if (nome && marcadorAtual) {
                pontosColeta.push({nome: nome, lat: marcadorAtual.lat, lon: marcadorAtual.lng});
                atualizarMapa(); fecharFormulario();
                // Tenta atualizar no JSONBin, mas ignora erro
                try {await fetch(JSON_URL, {method: "PUT", headers: {"Content-Type": "application/json", "X-Master-Key": MASTER_KEY}, body: JSON.stringify(pontosColeta)});} catch (e) {console.warn("Erro ao salvar no JSONBin:", e);}
            } else alert("Digite o nome do ponto!");
        }

        function fecharFormulario() {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('nome').value = ""; marcadorAtual = null;
        }

        var sidebar = document.getElementById('sidebar');
        document.getElementById('toggleSidebar').onclick = function () {sidebar.classList.toggle('active');}

        atualizarMapa();

        // ===== SISTEMA DE ANALYTICS =====
        function getStats() {
            return {
                visits: parseInt(localStorage.getItem('recicla_visits') || '0'),
                whatsappClicks: parseInt(localStorage.getItem('recicla_whatsapp_clicks') || '0'),
                phoneClicks: parseInt(localStorage.getItem('recicla_phone_clicks') || '0')
            };
        }

        function incrementStat(key) {
            const currentValue = parseInt(localStorage.getItem(key) || '0');
            localStorage.setItem(key, currentValue + 1);
        }

        // Registrar visita
        incrementStat('recicla_visits');

        // Rastrear cliques no WhatsApp
        document.querySelector('.btn-whatsapp').addEventListener('click', function() {
            incrementStat('recicla_whatsapp_clicks');
        });

        // Rastrear cliques no Telefone
        document.querySelector('.btn-phone').addEventListener('click', function() {
            incrementStat('recicla_phone_clicks');
        });

        // ===== MODAL DE CONTE√öDO EDUCATIVO =====
        const modalOverlay = document.getElementById('modal-overlay');
        const modalClose = document.getElementById('modal-close');
        const btnEducation = document.getElementById('btnEducation');

        btnEducation.onclick = function() {
            modalOverlay.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        modalClose.onclick = function() {
            modalOverlay.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        modalOverlay.onclick = function(e) {
            if (e.target === modalOverlay) {
                modalOverlay.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // ===== PAINEL DE ESTAT√çSTICAS (ADMIN) =====
        const statsPanel = document.getElementById('stats-panel');
        const statsOverlay = document.getElementById('stats-overlay');
        const btnStats = document.getElementById('btnStats');

        // Atalho para ativar bot√£o de estat√≠sticas: pressione Ctrl+Shift+S
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                btnStats.style.display = btnStats.style.display === 'none' ? 'inline-block' : 'none';
            }
        });

        btnStats.onclick = function() {
            const stats = getStats();
            document.getElementById('stat-visits').textContent = stats.visits;
            document.getElementById('stat-whatsapp').textContent = stats.whatsappClicks;
            document.getElementById('stat-phone').textContent = stats.phoneClicks;
            
            statsPanel.style.display = 'block';
            statsOverlay.style.display = 'block';
        }

        function closeStats() {
            statsPanel.style.display = 'none';
            statsOverlay.style.display = 'none';
        }

        statsOverlay.onclick = closeStats;
    </script>

</body>

</html>